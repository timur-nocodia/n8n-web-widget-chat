# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## IMPORTANT RULES

YOU ARE NOT ALLOWED TO DO SIMPLIFICATION OR COMPLICATION WITHOUT USER'S PERMISSION!!!
No 'more robust solutions' and such. YOU ALWAYS ASK BEFORE DOING THINGS ANOTHER WAY!

## Project Overview

This is a secure chat proxy system for e-commerce platforms, built with a React TypeScript frontend and FastAPI Python backend. The system acts as a secure intermediary between embedded chat widgets and n8n workflows for AI-powered customer support.

## Architecture

The project is a Turbo monorepo with two main applications:

- **chat-widget** (`apps/chat-widget/`): React TypeScript chat widget (Vite) that embeds via iframe on websites
- **proxy-server** (`apps/proxy-server/`): FastAPI Python server that handles authentication, rate limiting, and n8n integration

The system uses:
- PostgreSQL for session storage (async SQLAlchemy)
- Redis for rate limiting and caching  
- n8n workflows for AI processing
- JWT tokens for secure authentication with browser fingerprinting
- Server-sent events (SSE) for real-time chat streaming

## Common Development Commands

### Project Setup
```bash
# Docker-based setup (recommended)
./scripts/setup.sh

# Manual setup (if not using Docker)
npm install  # Install root dependencies
cd apps/chat-widget && npm install
cd apps/proxy-server && pip install -r requirements.txt
```

### Development
```bash
# Start all services with Turbo
npm run dev        # Runs all apps in parallel
turbo dev          # Alternative command

# Individual services
cd apps/chat-widget && npm run dev    # Frontend on port 5173
cd apps/proxy-server && python src/main.py  # Backend on port 8000

# Docker Compose (includes PostgreSQL and Redis)
cd infrastructure/docker
docker-compose up --build
```

### Production Server
```bash
# Run production-optimized server
cd apps/proxy-server && python main_production.py

# Or with Docker
docker-compose up -d  # Root directory docker-compose.yml
```

### Building and Testing
```bash
# Build all apps
npm run build
turbo build

# Frontend build and type checking
cd apps/chat-widget && npm run build && npm run type-check

# Backend testing
cd apps/proxy-server && python -m pytest

# Linting
npm run lint       # All apps via Turbo
cd apps/chat-widget && npm run lint
cd apps/proxy-server && ruff check . && black --check .

# Security testing
./scripts/test-security.sh
```

## Key File Structure

### Frontend (React TypeScript)
- `apps/chat-widget/src/embed.ts`: Creates iframe-based widget for embedding
- `apps/chat-widget/src/components/`: Modular React components
- `apps/chat-widget/src/services/api.ts`: Backend communication
- `apps/chat-widget/src/hooks/useSSE.ts`: Real-time SSE streaming
- `apps/chat-widget/modern-widget.html`: Standalone widget HTML

### Backend (FastAPI Python)
- `apps/proxy-server/src/main.py`: Main FastAPI application with middleware
- `apps/proxy-server/main_production.py`: Production server entry point
- `apps/proxy-server/src/core/security.py`: JWT, session management, threat detection
- `apps/proxy-server/src/core/config.py`: Settings and environment configuration
- `apps/proxy-server/src/services/rate_limiter.py`: Redis-based sliding window rate limits
- `apps/proxy-server/src/services/n8n_client.py`: n8n webhook integration with streaming
- `apps/proxy-server/src/services/jwt_service.py`: JWT token generation and validation
- `apps/proxy-server/src/services/sse_manager.py`: SSE connection management
- `apps/proxy-server/src/models/`: SQLAlchemy models (session.py, chat.py)
- `apps/proxy-server/src/api/v1/endpoints/`: API route handlers (chat.py, session.py)
- `apps/proxy-server/src/middleware/`: Security, rate limiting, error handling middleware

## Configuration

### Environment Files
- `apps/proxy-server/.env`: Backend configuration (create from .env.example)
- Docker Compose passes environment variables for containerized development

### Key Environment Variables
```bash
# Required for backend
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/chat_proxy
REDIS_URL=redis://localhost:6379/0
JWT_SECRET_KEY=<secure-secret>  # Generated by setup.sh
SESSION_SECRET_KEY=<secure-secret>  # Generated by setup.sh
N8N_WEBHOOK_URL=https://your-n8n-instance.com/webhook/chat
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:8000

# Optional
N8N_API_KEY=<api-key>
RATE_LIMIT_PER_MINUTE=60
RATE_LIMIT_PER_HOUR=1000
LOG_LEVEL=WARNING  # INFO for development, WARNING for production
```

## Widget Integration

### Embed on website
```html
<script>
  (function() {
    var script = document.createElement('script');
    script.src = 'https://yourchatserver.com/widget/embed.js';
    script.async = true;
    document.head.appendChild(script);
  })();
</script>
```

### Direct iframe
```html
<iframe src="https://yourchatserver.com/widget/modern-widget.html" 
        width="400" height="600" style="border: none;">
</iframe>
```

## API Endpoints

### Core Endpoints
- `GET /health`: Detailed health status with service checks
- `GET /metrics`: System metrics and connection stats
- `POST /api/v1/session/create`: Create secure chat session
- `GET /api/v1/session/validate`: Validate existing session
- `POST /api/v1/chat/message`: Send message (SSE stream response)
- `GET /api/v1/chat/stream/{session_id}`: SSE endpoint for real-time updates
- `GET /widget/*`: Serve widget static files

## n8n Integration

The system integrates with n8n for AI processing:
- Configure webhook URL in n8n workflow
- Enable streaming response in webhook settings
- JWT tokens are passed in headers for validation
- Supports SSE for real-time streaming responses

## Security Features

- JWT-based authentication with browser fingerprinting
- Multi-tier rate limiting (IP, session, domain)
- Input sanitization and XSS protection
- Comprehensive security headers and CORS
- Bot and spam detection
- Circuit breaker pattern for external services
- Session validation and expiry
- Request signature validation

## Development Tips

1. **Hot Reloading**: Both frontend (Vite) and backend (uvicorn --reload) support hot reloading
2. **Database**: PostgreSQL runs in Docker, tables are auto-created on startup
3. **Testing Widget**: Visit `http://localhost:8000/widget/modern-widget.html` or `http://localhost:5173/modern-widget.html`
4. **Logs**: Use `docker-compose logs -f [service]` to view logs
5. **Rate Limits**: Can be tested with `./scripts/test-security.sh`

## Important Implementation Notes

- Widget embeds via iframe for security isolation
- All user inputs are sanitized for XSS/injection protection  
- Rate limiting uses sliding window algorithm with Redis
- SSE connections managed with heartbeat and cleanup
- JWT tokens include browser fingerprinting for added security
- Database uses async SQLAlchemy with connection pooling
- Production server uses multiple workers (uvicorn with --workers flag)